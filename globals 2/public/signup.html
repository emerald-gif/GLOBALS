<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signup | Globals</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body { background: linear-gradient(135deg, #e0f2fe, #fff); }
    .glass { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); }
    .glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.32); }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen px-4">

  <div class="w-full max-w-md glass p-6 rounded-2xl">
    <div class="mb-6 text-center">
      <img src="VERIFIED.jpg" alt="Globals Logo" class="mx-auto h-16 w-16 mb-2">
      <h2 class="text-2xl font-extrabold text-blue-700">Create Account</h2>
      <p class="text-sm text-gray-600 mt-2">Enter your details to create account ‚Äî Signup is free.</p>
    </div>

    <form id="signupForm" class="space-y-4">
      <div><input type="text" id="fullName" placeholder="Full Name" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500" required /><p id="fullNameError" class="text-red-500 text-sm mt-1 hidden"></p></div>
      <div><input type="text" id="username" placeholder="Username" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500" required /><p id="usernameError" class="text-red-500 text-sm mt-1 hidden"></p></div>
      <div><input type="tel" id="phone" placeholder="Phone Number" maxlength="11" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500" required /><p id="phoneError" class="text-red-500 text-sm mt-1 hidden"></p></div>
      <div><input type="email" id="email" placeholder="Email (must be Gmail)" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500" required /><p id="emailError" class="text-red-500 text-sm mt-1 hidden"></p></div>

      <div class="relative">
        <input type="password" id="password" placeholder="Password" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 pr-10" required />
        <span onclick="togglePassword('password','togglePasswordIcon')" class="absolute inset-y-0 right-3 flex items-center cursor-pointer">
          <i data-feather="eye-off" id="togglePasswordIcon"></i>
        </span>
        <p id="passwordError" class="text-red-500 text-sm mt-1 hidden"></p>
      </div>

      <div class="relative">
        <input type="password" id="confirmPassword" placeholder="Confirm Password" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 pr-10" required />
        <span onclick="togglePassword('confirmPassword','toggleConfirmPasswordIcon')" class="absolute inset-y-0 right-3 flex items-center cursor-pointer">
          <i data-feather="eye-off" id="toggleConfirmPasswordIcon"></i>
        </span>
        <p id="confirmPasswordError" class="text-red-500 text-sm mt-1 hidden"></p>
      </div>

      <input type="text" id="referrer" placeholder="Referral Username (Optional)" class="w-full p-3 rounded-lg border" />

      <div>
        <select id="heardAbout" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500" required>
          <option value="">How did you hear about us?</option>
          <option value="Instagram">Instagram</option>
          <option value="TikTok">TikTok</option>
          <option value="Facebook">Facebook</option>
          <option value="WhatsApp">WhatsApp</option>
          <option value="X">X (Twitter)</option>
          <option value="Telegram">Telegram</option>
          <option value="Friend">Friend</option>
          <option value="Others">Others</option>
        </select>
        <p id="heardAboutError" class="text-red-500 text-sm mt-1 hidden"></p>
      </div>

      <button id="submitBtn" type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 glow">üöÄ Sign Up (Free)</button>
    </form>

    <p class="mt-5 text-sm text-center">Already have an account? <a href="login.html" class="text-blue-600 font-medium hover:underline">Login here</a></p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ---------- config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCuI_Nw4HMbDWa6wR3FhHJMHOUgx53E40c",
      authDomain: "globals-17bf7.firebaseapp.com",
      projectId: "globals-17bf7",
      storageBucket: "globals-17bf7.appspot.com",
      messagingSenderId: "603274362994",
      appId: "1:603274362994:web:c312c10cf0a42938e882eb"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // initialize EmailJS (public key you gave)
    emailjs.init("tfc9HSxyhDy5qonKZ"); // <-- your EmailJS public key

    const EMAILJS_SERVICE_ID = "service_5m7hr4q"; // <-- replace with your EmailJS service id
    const TEMPLATE_VERIFY = "template_4nr76pb";       // your verify template id
    const TEMPLATE_WELCOME = "template_u69npjv";     // your welcome template id

    // UI helpers
    function togglePassword(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      if (input.type === "password") { input.type = "text"; icon.setAttribute("data-feather","eye"); }
      else { input.type = "password"; icon.setAttribute("data-feather","eye-off"); }
      feather.replace();
    }
    feather.replace();

    // validators (same as your original)
    const validators = {
      fullName: v => v.trim() ? "" : "Full name is required",
      username: v => v.trim() ? "" : "Username is required",
      phone: v => /^[0-9]{11}$/.test(v) ? "" : "Phone must be 11 digits",
      email: v => /^[^ ]+@gmail\.com$/.test(v) ? "" : "Email must be a valid @gmail.com",
      password: v => v.length >= 6 ? "" : "Password must be at least 6 characters",
      confirmPassword: v => v === document.getElementById("password").value ? "" : "Passwords do not match",
      heardAbout: v => v ? "" : "Please select an option"
    };
    Object.keys(validators).forEach(id => {
      const el = document.getElementById(id);
      const err = document.getElementById(id + "Error");
      if (!el) return;
      el.addEventListener("input", () => {
        const msg = validators[id](el.value);
        if (msg) { err.textContent = msg; err.classList.remove("hidden"); }
        else { err.classList.add("hidden"); }
      });
    });



  // helper: generate 4-digit OTP
  function genOtp() {
    return Math.floor(1000 + Math.random() * 9000).toString();
  }

  // Submit handler
  document.getElementById("signupForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    // validate all
    let valid = true;
    Object.keys(validators).forEach(id => {
      const input = document.getElementById(id);
      const errorEl = document.getElementById(id + "Error");
      if (!input) return;
      const msg = validators[id](input.value);
      if (msg) { errorEl.textContent = msg; errorEl.classList.remove("hidden"); valid = false; }
      else { errorEl.classList.add("hidden"); }
    });
    if (!valid) return;

    // collect values
    const fullName = document.getElementById('fullName').value.trim();
    const username = document.getElementById('username').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const referrerUsername = document.getElementById('referrer').value.trim();
    const heardAbout = document.getElementById('heardAbout').value;

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Checking...';

    try {
      // ‚úÖ 1) Check if phone already exists in Firestore
      const phoneSnap = await db.collection("users").where("phone", "==", phone).limit(1).get();
      if (!phoneSnap.empty) {
        alert("‚ùå Phone number already registered. Please login or use another.");
        submitBtn.disabled = false;
        submitBtn.textContent = 'üöÄ Sign Up (Free)';
        return;
      }

      submitBtn.textContent = 'Creating account...';

      // ‚úÖ 2) Create Firebase Auth user (this also checks if email is already used)
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const userId = userCredential.user.uid;

      // ‚úÖ 3) Generate OTP and expiry
      const otp = genOtp();
      const now = Date.now();
      const otpExpires = now + (10 * 60 * 1000); // 10 minutes
      const lastOtpSentAt = now;

      // ‚úÖ 4) Save user document in Firestore
      const userData = {
        fullName,
        username,
        phone,
        email,
        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        balance: 0,
        referrer: referrerUsername || null,
        heardAbout,
        verified: false,
        otp,
        otpExpires,
        lastOtpSentAt
      };
      await db.collection("users").doc(userId).set(userData);

      // ‚úÖ 5) Send OTP email via EmailJS
      const templateParams = { to_email: email, otp: otp, name: fullName };
      emailjs.send(EMAILJS_SERVICE_ID, TEMPLATE_VERIFY, templateParams)
        .catch(() => {
          // not blocking ‚Äî user can still verify
          alert("‚ö†Ô∏è Account created, but OTP email failed. Please request resend.");
        });

      // ‚úÖ 6) Redirect immediately (fast experience)
      window.location.href = `verify.html?uid=${encodeURIComponent(userId)}&email=${encodeURIComponent(email)}`;

    } catch (error) {
      console.error(error);
      let msg = "Signup failed. Please try again.";
      if (error.code === "auth/email-already-in-use") msg = "‚ùå Email already registered. Please login instead.";
      else if (error.code === "auth/invalid-email") msg = "‚ùå Invalid email address.";
      else if (error.code === "auth/weak-password") msg = "‚ùå Password too weak. Use at least 6 characters.";

      alert(msg);
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ Sign Up (Free)';
    }
  });
</script>
</body>
</html>


