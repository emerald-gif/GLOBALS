<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Affiliate Tasks | Globals</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <!-- âœ… Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- âœ… Your main Firebase config -->
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyCuI_Nw4HMbDWa6wR3FhHJMHOUgx53E40c",
  authDomain: "globals-17bf7.firebaseapp.com",
  projectId: "globals-17bf7",
  storageBucket: "globals-17bf7.appspot.com",
  messagingSenderId: "603274362994",
  appId: "1:603274362994:web:c312c10cf0a42938e882eb"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore(); 

</script>






  <!-- âœ… Styles -->
  <style>
    /* Affiliate (aff2) section UI styling */
    .aff2-card { box-shadow: 0 10px 22px rgba(12,36,75,0.06), 0 4px 8px rgba(12,36,75,0.04); }
    .aff2-btn-big { box-shadow: 0 6px 14px rgba(37,99,235,0.18); border-radius: 12px; }
    .aff2-hidden { display:none; }
    .aff2-clickable { cursor:pointer; }
    @media (max-width:640px) { #aff2_grid { grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; } }
  </style>
</head>

<body class="bg-gradient-to-br from-[#f8fafc] via-[#ffffff] to-[#f1f5f9] min-h-screen">

  <!-- ================= AFFILIATE SECTION ================= -->
  <div id="aff2_root" class="px-4 py-6">

    <!-- ğŸ”™ Back button -->
    <button onclick="window.location.href='dashboard.html'"
      class="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
           viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round"
           stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      Back
    </button>

    <!-- ğŸ”¹ Header -->
    <h2 class="mb-3 flex items-center gap-2">
      <span class="inline-block w-1.5 h-6 rounded-full bg-blue-600"></span>
      <span class="text-lg font-bold text-gray-800 tracking-tight">Affiliate Tasks</span>
    </h2>

    <!-- ğŸ” Search -->
    <div class="flex items-center gap-4 mb-6">
      <div class="flex-1 relative">
        <input id="aff2_searchMain" type="text" placeholder="Search tasks, campaigns, titles..."
               class="w-full px-4 py-3 pl-12 rounded-2xl border focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
        <svg class="w-5 h-5 absolute left-4 top-3 text-gray-400" fill="none"
             stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round"
                   d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>

      <button id="aff2_openFinishedBtn"
        class="px-4 py-3 rounded-2xl bg-white border shadow-sm hover:shadow-md text-blue-600 font-medium">
        Finished Tasks
      </button>
    </div>

    <!-- ğŸ§© Tasks Grid -->
    <!-- ğŸ§© Tasks Grid -->
<div id="aff2_jobsContainer">
  <section id="aff2_jobsGridSection">
    <div id="aff2_grid" class="grid grid-cols-2 gap-4"></div>
  </section>
</div>

<!-- ğŸ“ Job Details -->
<div id="aff2_jobDetailScreen" class="aff2-hidden px-4 py-6">
  <div id="aff2_jobDetailContent"></div>
</div>

    <!-- âœ… Finished Tasks -->
    <div id="aff2_finishedScreen" class="aff2-hidden px-4 py-8 bg-gray-50 min-h-[60vh]">
      <div class="flex items-center justify-between mb-6">
        <button id="aff2_backToMainBtn" class="text-blue-600 font-medium flex items-center gap-1 hover:underline">
          â† Back
        </button>
        <h2 class="text-xl font-bold tracking-tight">Finished Tasks</h2>
      </div>

      <div class="relative mb-6">
        <input id="aff2_searchFinished" type="text" placeholder="Search finished tasks..."
               class="w-full px-4 py-3 pl-10 rounded-2xl border focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
        <svg class="w-5 h-5 absolute left-3 top-3 text-gray-400" fill="none"
             stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round"
                   d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="text-center bg-yellow-50 border border-yellow-200 rounded-2xl py-4 shadow-sm">
          <p id="aff2_pendingCount" class="text-3xl font-extrabold text-yellow-600">0</p>
          <p class="text-sm text-gray-600">Pending</p>
        </div>
        <div class="text-center bg-green-50 border border-green-200 rounded-2xl py-4 shadow-sm">
          <p id="aff2_approvedCount" class="text-3xl font-extrabold text-green-600">0</p>
          <p class="text-sm text-gray-600">Approved</p>
        </div>
      </div>

      <div id="aff2_finishedList" class="grid gap-5"></div>
    </div>
  </div>

  <!-- âœ… Affiliate V2 JS -->
  <script>



â€(function(){
â€'use strict';
â€
â€// Single-instance guard
â€if (window.AFF2_INSTANCE) { console.warn('[AFF2] Instance already present â€” skipping second init.'); return; }
â€
â€// tiny helpers
â€const safeText = s => String(s||'')
â€.replaceAll('&','&').replaceAll('<','<').replaceAll('>','>').replaceAll('"','"').replaceAll("'","'");
â€const formatNaira = n => (n==null||isNaN(Number(n))) ? 'â‚¦0' : 'â‚¦'+Number(n).toLocaleString('en-NG');
â€const el = id => document.getElementById(id);
â€
â€// Defensive firebase pick
â€const firebaseAvailable = !!(window.firebase && window.firebase.firestore);
â€const db = firebaseAvailable ? window.firebase.firestore() : null;
â€const auth = (window.firebase && window.firebase.auth) ? window.firebase.auth() : null;
â€
â€// Realtime multiplexer: coalesces identical queries so we don't attach duplicate onSnapshots
â€function RealtimeMultiplexer(db) {
â€const registry = new Map();
â€return {
â€subscribe(key, buildQueryFn, onUpdate) {
â€if (!db) return () => {};
â€if (registry.has(key)) {
â€const entry = registry.get(key);
â€entry.subs.add(onUpdate);
â€// call immediately with latest snapshot if available
â€if (entry.latest) try{ onUpdate(entry.latest);}catch(e){console.error(e)}
â€return () => {
â€entry.subs.delete(onUpdate);
â€if (entry.subs.size===0) {
â€try{ entry.unsub && entry.unsub(); }catch(){}
â€registry.delete(key);
â€}
â€};
â€}
â€// create new listener
â€const subs = new Set([onUpdate]);
â€let latest = null;
â€let unsub = null;
â€try {
â€const q = buildQueryFn(db);
â€unsub = q.onSnapshot(snap => {
â€const arr = [];
â€snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
â€latest = arr;
â€for (const s of subs) try{ s(arr);}catch(e){console.error(e)}
â€}, err => { console.error('[AFF2] multiplexer snapshot error', err); });
â€} catch (err) { console.error('[AFF2] multiplexer build error', err); }
â€registry.set(key, { subs, unsub, latest });
â€return () => {
â€const entry = registry.get(key);
â€if (!entry) return;
â€entry.subs.delete(onUpdate);
â€if (entry.subs.size===0) { try{ entry.unsub && entry.unsub(); }catch(){} registry.delete(key); }
â€};
â€}
â€};
â€}
â€
â€const multiplexer = db ? RealtimeMultiplexer(db) : null;
â€
â€// Module state
â€const state = {
â€instanceId: 'aff2_' + Math.random().toString(36).slice(2,9),
â€unsubscribers: [],
â€listeners: [],
â€currentDetailJobId: null
â€};
â€
â€// ======= RENDERERS (use DOM API, minimal innerHTML) =======
â€function makeJobCard(job) {
â€const accepted = Number(job.filledWorkers || 0);
â€const total = Number(job.numWorkers || 0);
â€const percent = total>0 ? Math.min(100, Math.round((accepted/total)*100)) : 0;
â€const img = job.campaignLogoURL || job.image || '/assets/default-thumb.jpg';
â€
â€const wrap = document.createElement('div');Â  
â€wrap.className = 'bg-white rounded-2xl aff2-card p-3';Â  
â€
â€const inner = document.createElement('div');Â  
â€inner.innerHTML = `Â  
â€Â  <div class="overflow-hidden rounded-xl">Â  
â€Â Â Â  <img src="${safeText(img)}" alt="${safeText(job.title||'')}" class="w-full h-36 object-cover rounded-xl" />Â  
â€Â  </div>Â  
â€Â  <div class="mt-3">Â  
â€Â Â Â  <h4 class="font-semibold text-md">${safeText(job.title||'')}</h4>Â  
â€Â Â Â  <div class="text-sm text-gray-500 mt-1">${formatNaira(job.workerPay)}</div>Â  
â€Â Â Â  <div class="text-sm text-gray-500 mt-1">${accepted}/${total} workers Â· ${percent}%</div>Â  
â€Â Â Â  <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden mt-3">Â  
â€Â Â Â Â Â  <div style="width:${percent}%" class="h-2 rounded-full bg-blue-300 transition-all duration-300"></div>Â  
â€Â Â Â  </div>Â  
â€Â Â Â  <div class="mt-4 flex gap-2">Â  
â€Â Â Â Â Â  <button class="flex-1 py-2 rounded-xl bg-blue-600 text-white font-semibold aff2_view_task aff2-clickable" data-id="${safeText(job.id)}">View Task</button>Â  
â€Â Â Â  </div>Â  
â€Â  </div>Â  
â€`;Â  
â€
â€wrap.appendChild(inner);Â  
â€return wrap;
â€
â€}
â€
â€function renderGrid(jobs) {
â€const grid = el('aff2_grid');
â€if (!grid) return;
â€// diff approach: simple replace for now to keep code robust and deterministic
â€grid.innerHTML = '';
â€if (!jobs || !jobs.length) {
â€const empty = document.createElement('div');
â€empty.className = 'col-span-2 p-6 bg-white rounded-xl aff2-card text-center';
â€empty.textContent = 'No affiliate tasks right now.';
â€grid.appendChild(empty);
â€return;
â€}
â€const frag = document.createDocumentFragment();
â€for (const j of jobs) frag.appendChild(makeJobCard(j));
â€grid.appendChild(frag);
â€}
â€
â€function makeFinishedCard(sub, jobTitle) {
â€const wrap = document.createElement('div');
â€wrap.className = 'p-4 bg-white rounded-xl shadow-sm flex items-center justify-between hover:shadow-md';
â€const left = document.createElement('div');
â€const h = document.createElement('h3'); h.className = 'font-semibold text-gray-900'; h.textContent = jobTitle || 'Affiliate Job';
â€const p1 = document.createElement('p'); p1.className='text-sm text-gray-600'; p1.textContent = sub.status || '';
â€const p2 = document.createElement('p'); p2.className='text-xs text-gray-400'; p2.textContent = (sub.postedAt && sub.postedAt.toDate) ? sub.postedAt.toDate().toLocaleString() : '';
â€left.appendChild(h); left.appendChild(p1); left.appendChild(p2);
â€
â€const right = document.createElement('div'); right.className='flex flex-col gap-2 items-end';Â  
â€const btn = document.createElement('button'); btn.className='px-3 py-1 text-sm font-medium bg-blue-600 text-white rounded-lg aff2_view_finished aff2-clickable'; btn.dataset.id = sub.id; btn.textContent = 'View';Â  
â€right.appendChild(btn);Â  
â€
â€wrap.appendChild(left); wrap.appendChild(right);Â  
â€return wrap;
â€
â€}
â€
â€function renderFinishedList(items, jobMap) {
â€const listEl = el('aff2_finishedList'); if (!listEl) return;
â€listEl.innerHTML = '';
â€if (!items || items.length===0) { listEl.innerHTML = '<p class="text-center text-gray-500">You have no finished tasks.</p>'; return; }
â€const frag = document.createDocumentFragment();
â€let pending=0, approved=0;
â€items.sort((a,b)=>((b.postedAt&&b.postedAt.seconds)||0)-((a.postedAt&&a.postedAt.seconds)||0));
â€for (const it of items) {
â€const s = (it.status||'').toLowerCase(); if (s==='approved') approved++; else pending++;
â€frag.appendChild(makeFinishedCard(it, jobMap[it.jobId]?.title));
â€}
â€listEl.appendChild(frag);
â€el('aff2_pendingCount') && (el('aff2_pendingCount').textContent = String(pending));
â€el('aff2_approvedCount') && (el('aff2_approvedCount').textContent = String(approved));
â€}
â€
â€// ======= SUBSCRIPTIONS =======
â€// Jobs grid subscription (shared via multiplexer)
â€function startJobsListener() {
â€if (!multiplexer) return;
â€const unsub = multiplexer.subscribe('aff2_jobs_approved', db=> db.collection('affiliateJobs').where('status','==','approved'), (jobs)=>{
â€// sort for stable order by postedAt
â€jobs.sort((a,b)=>((b.postedAt&&b.postedAt.seconds)||0)-((a.postedAt&&a.postedAt.seconds)||0));
â€renderGrid(jobs);
â€});
â€state.unsubscribers.push(unsub);
â€}
â€
â€// Finished tasks subscription for current user
â€let finishedLocalUnsub = null;
â€function startFinishedListenerForUser(uid) {
â€if (!multiplexer || !uid) return;
â€// factory returns a Query
â€const key = 'aff2_finished_user_'+uid;
â€// keep a short-lived local jobMap cache to render job titles
â€const jobMapCache = {};
â€const fetchJobMap = async (jobsIds) => {
â€if (!db) return {};
â€const unique = [...new Set(jobsIds||[])];
â€if (!unique.length) return {};
â€try {
â€// Firestore doesn't allow >10 in where-in; chunk if needed
â€const map = {};
â€for (let i=0;i<unique.length;i+=10) {
â€const chunk = unique.slice(i,i+10);
â€const snap = await db.collection('affiliateJobs').where(window.firebase.firestore.FieldPath.documentId(), 'in', chunk).get();
â€snap.forEach(d=> map[d.id] = d.data());
â€}
â€return map;
â€} catch(err){ console.error('[AFF2] fetchJobMap',err); return {}; }
â€};
â€
â€finishedLocalUnsub = multiplexer.subscribe(key, db=> db.collection('affiliate_submissions').where('userId','==',uid), async (items)=>{
â€const jobIds = items.map(i=>i.jobId).filter(Boolean);
â€const jm = await fetchJobMap(jobIds);
â€renderFinishedList(items, jm);
â€});
â€state.unsubscribers.push(()=>{ finishedLocalUnsub && finishedLocalUnsub(); finishedLocalUnsub=null; });
â€}
â€
â€// Job detail: subscribe for approved count
â€let jobDetailUnsub = null;
â€async function openJobDetail(jobId) {
â€if (!db) { alert('Database not ready'); return; }
â€try {
â€const doc = await db.collection('affiliateJobs').doc(jobId).get();
â€if (!doc.exists) { alert('Job not found'); return; }
â€const job = { id: doc.id, ...doc.data() };
â€state.currentDetailJobId = job.id;
â€
â€// render detail content (innerHTML for complex layout is ok here but safely encoded values)Â  
â€Â  const container = el('aff2_jobDetailContent'); if (!container) return;Â  
â€Â  container.innerHTML = '';Â  
â€Â  const wrapper = document.createElement('div'); wrapper.className='bg-white rounded-2xl aff2-card overflow-hidden';Â  
â€Â  const imgWrap = document.createElement('div'); imgWrap.className='relative';Â  
â€Â  const banner = document.createElement('img'); banner.src = job.campaignLogoURL||job.image||'/assets/default-banner.jpg'; banner.className='w-full h-44 object-cover';Â  
â€Â  const thumb = document.createElement('img'); thumb.src = job.campaignLogoURL||job.image||'/assets/default-thumb.jpg'; thumb.className='absolute -bottom-6 left-6 w-14 h-14 rounded-full border-4 border-white object-cover shadow';Â  
â€Â  imgWrap.appendChild(banner); imgWrap.appendChild(thumb);Â  
â€Â  wrapper.appendChild(imgWrap);Â  
â€
â€Â  const body = document.createElement('div'); body.className='p-5';Â  
â€Â  body.innerHTML = `Â  
â€Â Â Â  <div class="flex justify-between items-start"><div><h3 class="text-xl font-bold">${safeText(job.title||'Untitled')}</h3><p class="text-sm text-gray-500">${formatNaira(job.workerPay)} Â· ${Number(job.numWorkers||0)} workers</p></div></div>Â  
â€Â Â Â  <div class="mt-3 text-gray-700">${safeText(job.instructions||'')}</div>Â  
â€Â Â Â  <div class="mt-4"><div class="text-sm text-gray-500">Progress</div><div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden mt-2"><div id="aff2_detailProgressBar" class="h-2 rounded-full bg-blue-400" style="width:0%"></div></div><div id="aff2_detailProgressText" class="text-sm text-gray-500 mt-2">0/0 (0%)</div></div>Â  
â€Â Â Â  <hr class="my-4"/>Â  
â€Â Â Â  <div><p class="text-sm text-gray-500 mb-2">Proofs required: <strong id="aff2_detailProofCount">${Number(job.proofFileCount||1)}</strong></p>Â  
â€Â Â Â  <input id="aff2_detailProofFiles" type="file" multiple accept="image/*" class="mb-2 block w-full" />Â  
â€Â Â Â  <textarea id="aff2_detailSubmissionNote" placeholder="Optional note..." class="w-full border rounded-md p-2 mb-2"></textarea>Â  
â€Â Â Â  <div class="flex gap-2"><button id="aff2_detailSubmitBtn" data-job-id="${safeText(job.id)}" data-proof-count="${Number(job.proofFileCount||1)}" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-semibold">Submit Proof</button><button id="aff2_detailCancelBtn" class="py-3 px-4 rounded-xl bg-gray-100">Cancel</button></div>Â  
â€Â Â Â  <p class="text-xs text-gray-400 mt-2">Submissions are reviewed by admin. Approved submissions will reflect here and in Finished Tasks.</p></div>Â  
â€Â  `;Â  
â€
â€Â  wrapper.appendChild(body);Â  
â€Â  container.appendChild(wrapper);Â  
â€
â€Â  // show/hide screensÂ  
â€Â  el('aff2_jobsContainer') && el('aff2_jobsContainer').classList.add('aff2-hidden');Â  
â€Â  el('aff2_finishedScreen') && el('aff2_finishedScreen').classList.add('aff2-hidden');Â  
â€Â  el('aff2_jobDetailScreen') && el('aff2_jobDetailScreen').classList.remove('aff2-hidden');Â  
â€
â€Â  // subscribe to approved count via multiplexerÂ  
â€Â  if (jobDetailUnsub) { jobDetailUnsub(); jobDetailUnsub = null; }Â  
â€Â  jobDetailUnsub = multiplexer.subscribe('aff2_job_approved_'+job.id, d=> d.collection('affiliate_submissions').where('jobId','==',job.id).where('status','==','approved'), snap => {}); // NOTE: incorrect; factory must accept db; fixed belowÂ  
â€
â€} catch (err) { console.error('[AFF2] openJobDetail error',err); alert('Failed to open job. Check console.'); }
â€
â€}
â€
â€// Because we need the multiplexer factory to receive db, re-define the approved subscription correctly
â€async function openJobDetail_correct(jobId) {
â€if (!db) { alert('Database not ready'); return; }
â€try {
â€const doc = await db.collection('affiliateJobs').doc(jobId).get();
â€if (!doc.exists) { alert('Job not found'); return; }
â€const job = { id: doc.id, ...doc.data() };
â€state.currentDetailJobId = job.id;
â€
â€const container = el('aff2_jobDetailContent'); if (!container) return;Â  
â€Â  // build UI (we call the same helper as above but avoid repeating too much)Â  
â€Â  container.innerHTML = '';Â  
â€Â  const wrapper = document.createElement('div'); wrapper.className='bg-white rounded-2xl aff2-card overflow-hidden';Â  
â€Â  const imgWrap = document.createElement('div'); imgWrap.className='relative';Â  
â€Â  const banner = document.createElement('img'); banner.src = job.campaignLogoURL||job.image||'/assets/default-banner.jpg'; banner.className='w-full h-44 object-cover';Â  
â€Â  const thumb = document.createElement('img'); thumb.src = job.campaignLogoURL||job.image||'/assets/default-thumb.jpg'; thumb.className='absolute -bottom-6 left-6 w-14 h-14 rounded-full border-4 border-white object-cover shadow';Â  
â€Â  imgWrap.appendChild(banner); imgWrap.appendChild(thumb);Â  
â€Â  wrapper.appendChild(imgWrap);Â  
â€Â  const body = document.createElement('div'); body.className='p-5';
â€
â€body.innerHTML =Â Â  <div class="flex justify-between items-start"><div><h3 class="text-xl font-bold">${safeText(job.title||'Untitled')}</h3><p class="text-sm text-gray-500">${formatNaira(job.workerPay)} Â· ${Number(job.numWorkers||0)} workers</p></div></div>Â Â  <div class="mt-3 text-gray-700">${safeText(job.instructions||'')}</div>Â Â  <div class="mt-4"><div class="text-sm text-gray-500">Progress</div><div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden mt-2"><div id="aff2_detailProgressBar" class="h-2 rounded-full bg-blue-400" style="width:0%"></div></div><div id="aff2_detailProgressText" class="text-sm text-gray-500 mt-2">0/0 (0%)</div></div>Â Â  <hr class="my-4"/>Â Â  <div><p class="text-sm text-gray-500 mb-2">Proofs required: <strong id="aff2_detailProofCount">${Number(job.proofFileCount||1)}</strong></p>Â Â  <input id="aff2_detailProofFiles" type="file" multiple accept="image/*" class="mb-2 block w-full" />Â Â  <textarea id="aff2_detailSubmissionNote" placeholder="Optional note..." class="w-full border rounded-md p-2 mb-2"></textarea>Â Â  <div class="flex gap-2"><button id="aff2_detailSubmitBtn" data-job-id="${safeText(job.id)}" data-proof-count="${Number(job.proofFileCount||1)}" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-semibold">Submit Proof</button><button id="aff2_detailCancelBtn" class="py-3 px-4 rounded-xl bg-gray-100">Cancel</button></div>Â Â  <p class="text-xs text-gray-400 mt-2">Submissions are reviewed by admin. Approved submissions will reflect here and in Finished Tasks.</p></div>Â  ;
â€wrapper.appendChild(body);
â€container.appendChild(wrapper);
â€
â€el('aff2_jobsContainer')?.classList.add('aff2-hidden');Â  
â€Â  el('aff2_finishedScreen')?.classList.add('aff2-hidden');Â  
â€Â  el('aff2_jobDetailScreen')?.classList.remove('aff2-hidden');Â  
â€
â€Â  // previously subscribed detail listenerÂ  
â€Â  if (jobDetailUnsub) { try{ jobDetailUnsub(); }catch(_){} jobDetailUnsub=null; }Â  
â€
â€Â  // New subscription to count approved submissions. We use the multiplexer so if other modules subscribe to the same query they reuse the snapshot.Â  
â€Â  jobDetailUnsub = multiplexer.subscribe('aff2_job_approved_'+job.id, (dbLocal)=> dbLocal.collection('affiliate_submissions').where('jobId','==',job.id).where('status','==','approved'), (arr)=>{Â  
â€Â Â Â  const approvedCount = arr.length;Â  
â€Â Â Â  const totalWorkers = Number(job.numWorkers||0);Â  
â€Â Â Â  const percent = totalWorkers>0?Math.min(100, Math.round((approvedCount/totalWorkers)*100)):0;Â  
â€Â Â Â  const bar = el('aff2_detailProgressBar'); if (bar && bar.style) bar.style.width = percent + '%';Â  
â€Â Â Â  const tEl = el('aff2_detailProgressText'); if (tEl) tEl.textContent = `${approvedCount}/${totalWorkers} (${percent}%)`;Â  
â€Â  });Â  
â€Â  state.unsubscribers.push(jobDetailUnsub);Â  
â€
â€} catch (err) { console.error('[AFF2] openJobDetail_correct',err); alert('Failed to open job. See console.'); }
â€
â€}
â€
â€// ======= UPLOAD helper (keeps identical behaviour to older module) =======
â€async function uploadFileHelper(file) {
â€if (!file) throw new Error('No file provided');
â€if (typeof window.uploadToCloudinary === 'function') return await window.uploadToCloudinary(file);
â€if (window.firebase && window.firebase.storage && auth && auth.currentUser) {
â€const storageRef = window.firebase.storage().ref();
â€const path = affiliate_submissions/${auth.currentUser.uid}_${Date.now()}_${file.name};
â€const ref = storageRef.child(path);
â€await ref.put(file);
â€return await ref.getDownloadURL();
â€}
â€throw new Error('No upload helper available. Add uploadToCloudinary(file) or enable firebase.storage.');
â€}
â€
â€// ======= EVENT BINDINGS (container-scoped) =======
â€const handlers = [];
â€
â€function bindEvents() {
â€// Grid clicks
â€const grid = el('aff2_grid');
â€if (grid) {
â€const onGridClick = (ev) => {
â€const btn = ev.target.closest && ev.target.closest('.aff2_view_task');
â€if (btn) {
â€const id = btn.dataset.id;
â€if (id) openJobDetail_correct(id);
â€}
â€};
â€grid.addEventListener('click', onGridClick);
â€handlers.push(()=>grid.removeEventListener('click', onGridClick));
â€}
â€
â€// Finished list clicksÂ  
â€const finList = el('aff2_finishedList');Â  
â€if (finList) {Â  
â€Â  const onFinClick = (ev) => {Â  
â€Â Â Â  const btn = ev.target.closest && ev.target.closest('.aff2_view_finished');Â  
â€Â Â Â  if (!btn) return;Â  
â€Â Â Â  const subId = btn.dataset.id;Â  
â€Â Â Â  if (!subId) return;Â  
â€Â Â Â  // open modal for submission detailsÂ  
â€Â Â Â  if (!db) { alert('Database not ready'); return; }Â  
â€Â Â Â  db.collection('affiliate_submissions').doc(subId).get().then(doc=>{Â  
â€Â Â Â Â Â  if (!doc.exists) { alert('Submission not found'); return; }Â  
â€Â Â Â Â Â  const d = doc.data();Â  
â€Â Â Â Â Â  const images = (d.proofURLs||[]).map(u=>{ const img=document.createElement('img'); img.src=u; img.className='w-full rounded-md mb-2'; return img; });Â  
â€Â Â Â Â Â  const modal = document.createElement('div'); modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';Â  
â€Â Â Â Â Â  const box = document.createElement('div'); box.className='bg-white rounded-xl shadow-lg p-4 w-full max-w-md max-h-[90vh] overflow-y-auto';Â  
â€Â Â Â Â Â  const h = document.createElement('h3'); h.className='text-lg font-bold mb-2'; h.textContent='Submission Details';Â  
â€Â Â Â Â Â  box.appendChild(h);Â  
â€Â Â Â Â Â  const p1 = document.createElement('p'); p1.className='text-sm'; p1.innerHTML = `<strong>Status:</strong> ${safeText(d.status||'')}`;Â  
â€Â Â Â Â Â  const p2 = document.createElement('p'); p2.className='text-sm'; p2.innerHTML = `<strong>Note:</strong> ${safeText(d.note||'')}`;Â  
â€Â Â Â Â Â  box.appendChild(p1); box.appendChild(p2);Â  
â€Â Â Â Â Â  const imagesWrap = document.createElement('div'); imagesWrap.className='mt-3';Â  
â€Â Â Â Â Â  if (images.length) images.forEach(i=>imagesWrap.appendChild(i)); else imagesWrap.innerHTML='<p class="text-sm text-gray-400">No proof images</p>';Â  
â€Â Â Â Â Â  box.appendChild(imagesWrap);Â  
â€Â Â Â Â Â  const foot = document.createElement('div'); foot.className='mt-4 flex justify-end';Â  
â€Â Â Â Â Â  const closeBtn = document.createElement('button'); closeBtn.className='closeFinishedBtn px-4 py-2 bg-blue-600 text-white rounded-lg'; closeBtn.textContent='Close';Â  
â€Â Â Â Â Â  closeBtn.addEventListener('click', ()=>modal.remove());Â  
â€Â Â Â Â Â  foot.appendChild(closeBtn); box.appendChild(foot);Â  
â€Â Â Â Â Â  modal.appendChild(box); document.body.appendChild(modal);Â  
â€Â Â Â  }).catch(err=>{ console.error('[AFF2] load submission',err); alert('Failed to load details'); });Â  
â€Â  };Â  
â€Â  finList.addEventListener('click', onFinClick);Â  
â€Â  handlers.push(()=>finList.removeEventListener('click', onFinClick));Â  
â€}
â€
â€// top buttons
â€const openFin = el('aff2_openFinishedBtn'); if (openFin) { const fn=()=>{ if (auth && auth.currentUser) startFinishedListenerForUser(auth.currentUser.uid); el('aff2_jobsContainer')?.classList.add('aff2-hidden'); el('aff2_jobDetailScreen')?.classList.add('aff2-hidden'); el('aff2_finishedScreen')?.classList.remove('aff2-hidden'); }; openFin.addEventListener('click', fn); handlers.push(()=>openFin.removeEventListener('click', fn)); }
â€const backMain = el('aff2_backToMainBtn'); if (backMain) { const fn=()=>{ el('aff2_finishedScreen')?.classList.add('aff2-hidden'); el('aff2_jobsContainer')?.classList.remove('aff2-hidden'); if (typeof finishedLocalUnsub==='function') { finishedLocalUnsub(); finishedLocalUnsub=null; } }; backMain.addEventListener('click', fn); handlers.push(()=>backMain.removeEventListener('click', fn)); }
â€const backToList = el('aff2_backToListBtn'); if (backToList) { const fn=()=>{ el('aff2_jobDetailScreen')?.classList.add('aff2-hidden'); el('aff2_jobsContainer')?.classList.remove('aff2-hidden'); if (jobDetailUnsub) { try{ jobDetailUnsub(); }catch(_){} jobDetailUnsub=null; } }; backToList.addEventListener('click', fn); handlers.push(()=>backToList.removeEventListener('click', fn)); }
â€
â€// Submit proof and cancel are in detail screen; use delegated listener on detail screen containerÂ  
â€const detailScreen = el('aff2_jobDetailContent');Â  
â€const onDetailClick = async (ev) => {Â  
â€Â  const submitBtn = ev.target.closest && ev.target.closest('#aff2_detailSubmitBtn');Â  
â€Â  if (submitBtn) {Â  
â€Â Â Â  const jobId = submitBtn.dataset.jobId; if (!jobId) { alert('Job ID missing'); return; }Â  
â€Â Â Â  if (!auth || !auth.currentUser) { alert('Login to submit proof.'); return; }Â  
â€Â Â Â  const proofRequired = Number(submitBtn.dataset.proofCount||1);Â  
â€Â Â Â  const filesInput = el('aff2_detailProofFiles'); const files = filesInput?.files || [];Â  
â€Â Â Â  if (files.length !== proofRequired) { alert(`This job requires exactly ${proofRequired} file(s). You provided ${files.length}.`); return; }Â  
â€Â Â Â  submitBtn.disabled = true; const prev = submitBtn.textContent; submitBtn.textContent = 'Uploading...';Â  
â€Â Â Â  try {Â  
â€Â Â Â Â Â  const uploads = [];Â  
â€Â Â Â Â Â  for (let i=0;i<files.length;i++) uploads.push(uploadFileHelper(files[i]));Â  
â€Â Â Â Â Â  const urls = await Promise.all(uploads);Â  
â€Â Â Â Â Â  const payload = { jobId, userId: auth.currentUser.uid, userName: auth.currentUser.displayName || auth.currentUser.email || '', postedAt: (window.firebase&&window.firebase.firestore)?window.firebase.firestore.FieldValue.serverTimestamp():new Date(), proofURLs: urls, note: el('aff2_detailSubmissionNote')?.value||'', status: 'on review' };Â  
â€Â Â Â Â Â  await db.collection('affiliate_submissions').add(payload);Â  
â€Â Â Â Â Â  alert('âœ… Proof submitted! It will be reviewed by admin.');Â  
â€Â Â Â Â Â  el('aff2_backToListBtn')?.click();Â  
â€Â Â Â  } catch (err) { console.error('[AFF2] submit',err); alert('Failed to submit proof. See console.'); }Â  
â€Â Â Â  finally { submitBtn.disabled=false; submitBtn.textContent = prev; }Â  
â€Â  }Â  
â€Â  const cancelBtn = ev.target.closest && ev.target.closest('#aff2_detailCancelBtn');Â  
â€Â  if (cancelBtn) { el('aff2_backToListBtn')?.click(); }Â  
â€};Â  
â€// attach even if detail container not present yet; delegate at root (safe and localized)Â  
â€const root = el('aff2_root'); if (root) { root.addEventListener('click', onDetailClick); handlers.push(()=>root.removeEventListener('click', onDetailClick)); }Â  
â€
â€// search inputsÂ  
â€const sInput = el('aff2_searchMain'); if (sInput) {Â  
â€Â  let to=null; sInput.addEventListener('input', ()=>{ clearTimeout(to); to = setTimeout(()=>{ const q=sInput.value.trim().toLowerCase(); const grid = el('aff2_grid'); if (!grid) return; [...grid.children].forEach(card=>{ const txt=(card.innerText||'').toLowerCase(); card.style.display = txt.includes(q)?'':'none'; }); },170); }); handlers.push(()=>sInput.removeEventListener('input',null)); }Â  
â€const sf = el('aff2_searchFinished'); if (sf) { sf.addEventListener('input', ()=>{ const q=sf.value.trim().toLowerCase(); const list=el('aff2_finishedList'); if(!list) return; [...list.children].forEach(card=>{ const txt=(card.innerText||'').toLowerCase(); card.style.display = txt.includes(q)?'':'none'; }); }); handlers.push(()=>sf.removeEventListener('input',null)); }
â€
â€}
â€
â€// ======= AUTH CHANGES =======
â€function attachAuthWatcher() {
â€if (!auth) return;
â€const onAuth = (u)=>{
â€if (u) { startFinishedListenerForUser(u.uid); }
â€else { if (typeof finishedLocalUnsub==='function') { finishedLocalUnsub(); finishedLocalUnsub=null; } const listEl=el('aff2_finishedList'); if (listEl) listEl.innerHTML='<p class="text-center text-gray-500">Login to see your finished tasks.</p>'; }
â€};
â€auth.onAuthStateChanged(onAuth);
â€state.unsubscribers.push(()=>{/* no easy way to remove onAuthStateChanged callback in firebase v8-style; safe to leave */});
â€}
â€
â€// ======= INIT / DESTROY =======
â€function init() {
â€// attach events
â€bindEvents();
â€// start jobs stream
â€if (multiplexer) startJobsListener();
â€// attach auth watcher (to start finished tasks listener when user logs in)
â€attachAuthWatcher();
â€console.log('[AFF2] initialized (id: '+state.instanceId+')');
â€}
â€
â€function destroy() {
â€// remove event handlers
â€handlers.splice(0).forEach(un => { try{ un(); }catch(){} });
â€// unsubscribe realtime listeners
â€state.unsubscribers.splice(0).forEach(un => { try{ un(); }catch(){} });
â€// reset UI (optional)
â€const rootEl = el('aff2_root'); if (rootEl) rootEl.querySelectorAll('*').forEach(n=>n.removeEventListener && n.removeEventListener());
â€// clear root sections back to initial state
â€el('aff2_grid') && (el('aff2_grid').innerHTML='');
â€el('aff2_finishedList') && (el('aff2_finishedList').innerHTML='');
â€// clear module reference
â€try{ delete window.AFF2_INSTANCE; }catch(_){ window.AFF2_INSTANCE = null; }
â€console.log('[AFF2] destroyed');
â€}
â€
â€// auto-init on DOM ready
â€if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
â€
â€// expose a tiny API for control/debug
â€const api = { init, destroy, openJob: openJobDetail_correct, id: state.instanceId };
â€window.AFF2_INSTANCE = api; // single global reference
â€window.AffiliateV2 = api; // small convenience alias
â€})();
â€
â€
â€



</script>

</body>

</html>

