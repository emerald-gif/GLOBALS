â€Ž<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Check-In | Globals</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <!-- âœ… Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- âœ… Lucide Icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.264.0/dist/lucide.min.js"></script>

  <!-- âœ… Your Main JS (firebase config inside) -->
  <script src="main.js"></script>
</head>

<body class="bg-gradient-to-br from-[#f8fafc] via-[#ffffff] to-[#f1f5f9] p-6 min-h-screen">






<section id="watchAdsSection" class="tab-section hidden relative w-full pt-4 pb-10 bg-gradient-to-br from-indigo-50 via-white to-indigo-100 overflow-hidden">
  <!-- ðŸŒŸ Back Button -->
  <button onclick="activateTab('dashboard')" 
    class="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium mb-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back
  </button>

  <!-- gradient blur bg -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute -top-24 -left-32 w-96 h-96 bg-indigo-400/20 blur-3xl rounded-full"></div>  
    <div class="absolute bottom-0 right-0 w-[500px] h-[500px] bg-purple-300/20 blur-3xl rounded-full"></div>  
  </div>  

  <!-- title -->
  <div class="relative max-w-6xl mx-auto px-6 mb-6 text-center">  
    <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-800 to-indigo-600 bg-clip-text text-transparent">  
      Watch Ads & Earn  
    </h2>  
    <p class="text-gray-600 mt-2 text-sm md:text-base">  
      Watch short video ads and earn instant rewards â€” watched ads reset on reloads so you can come back and watch more. 
    </p>  
  </div>  

  <!-- top stats -->
  <div class="relative max-w-4xl mx-auto mb-8 grid grid-cols-2 sm:grid-cols-5 gap-4 px-6">  
    <div class="rounded-2xl bg-white/70 border border-indigo-100 backdrop-blur-xl p-4 text-center shadow-sm">  
      <div class="text-xs text-gray-500">Clicked</div>  
      <div id="statClicked" class="text-lg font-semibold text-indigo-700">0</div>  
    </div>  
    <div class="rounded-2xl bg-white/70 border border-indigo-100 backdrop-blur-xl p-4 text-center shadow-sm">  
      <div class="text-xs text-gray-500">Completed</div>  
      <div id="statCompleted" class="text-lg font-semibold text-green-700">0</div>  
    </div>  
    <div class="rounded-2xl bg-white/70 border border-indigo-100 backdrop-blur-xl p-4 text-center shadow-sm">  
      <div class="text-xs text-gray-500">Skipped</div>  
      <div id="statAbandoned" class="text-lg font-semibold text-rose-600">0</div>  
    </div>  
    <div class="rounded-2xl bg-white/70 border border-indigo-100 backdrop-blur-xl p-4 text-center shadow-sm">  
      <div class="text-xs text-gray-500">Ad Income (today)</div>  
      <div id="statIncome" class="text-lg font-semibold text-blue-700">â‚¦0.00</div>  
    </div>  
    <div class="rounded-2xl bg-white/70 border border-indigo-100 backdrop-blur-xl p-4 text-center shadow-sm">  
      <div class="text-xs text-gray-500">Ad Income (total)</div>  
      <div id="statAdTotal" class="text-lg font-semibold text-gray-900">â‚¦0.00</div>  
    </div> 
	  <div class="rounded-2xl bg-white/70 border border-indigo-100 backdrop-blur-xl p-4 text-center shadow-sm">
  <div class="text-xs text-gray-500">Bonus Balance</div>
  <div class="text-lg font-semibold text-emerald-700">â‚¦0.00</div>
	  </div>
	  
  </div>  



     <div class="relative max-w-6xl mx-auto px-6 mb-4 mt-8">
  <h3 class="text-xl font-semibold text-indigo-800 flex items-center gap-2">
    <i data-lucide="play-circle" class="w-5 h-5 text-indigo-600"></i>
    Available Ads
  </h3>
  <div class="h-[2px] bg-gradient-to-r from-indigo-500 via-purple-400 to-transparent mt-2 rounded-full"></div>
</div>
	
  <!-- ad cards grid -->
  <div class="relative max-w-6xl mx-auto px-6">  
    <div id="adsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>  
  </div>  
</section>  

<!-- ad modal -->
<div id="adModal" class="fixed inset-0 hidden z-60 bg-black/60 flex items-center justify-center" aria-hidden="true">
  <div class="bg-white rounded-3xl shadow-xl overflow-hidden max-w-2xl w-[92%] relative">
    <button id="closeAd" class="absolute top-3 right-3 bg-gray-100 hover:bg-gray-200 p-2 rounded-full z-30" aria-label="Close ad">
      <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
    </button>


<!-- progress + time (read-only) -->
    <div id="videoProgressWrap" class="px-6 pt-6 pb-3">
      <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
        <div id="videoProgress" class="h-full w-0 bg-indigo-600 transition-all duration-150"></div>
      </div>
      <div class="flex justify-between mt-2 text-xs text-slate-500">
        <div id="videoTimeLabel">00:00 / 00:00</div>
        <div id="videoRemainingLabel"></div>
      </div>
    </div>

    <!-- player area with fallback overlay + spinner -->
    <div class="px-6 pb-6 relative flex justify-center items-center">
      <video id="adPlayer" class="w-full rounded-lg bg-black" playsinline preload="metadata" aria-label="Ad player"></video>

      <!-- friendly fallback message (script expects id="adFallbackMessage") -->
      <div id="adFallbackMessage" class="absolute inset-0 flex items-center justify-center bg-black/80 text-white text-sm rounded-lg hidden">
        No ad available. Please try again later.
      </div>

      <!-- spinner shown while loading (script may hide it) -->
      <div id="adSpinner" class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>  
</div>


<div id="toastContainer" class="fixed top-6 right-6 z-50 flex flex-col gap-2"></div>

		


		
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn { animation: fadeIn 0.6s ease-in-out; }

  /* ensure the modal video area keeps aspect and doesn't overflow on very small screens */
  #adModal video { max-height: 60vh; object-fit: cover; border-radius: 10px; }
</style>










<script>

(function () {
â€Ž'use strict';
â€Ž
â€Ž// ====== CONFIG ======
â€Žconst REWARD_NAIRA = 0.5;
â€Žconst NUM_CARDS = 20;
â€Žconst VAST_LINK = 'https://silkyspite.com/dFm.FkzMdRGUN/vPZhGFUX/geYmX9Su/Z-UKluk/PWTvYb2gNEzHAo2/N/zaQ/tBNNj/YB3rMaDXYw3kNAQr';
â€Žconst HLS_JS_SRC = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
â€Ž
â€Ž// ====== SAFE FIREBASE ACCESS ======
â€Žconst auth = (window.firebase && typeof firebase.auth === 'function') ? firebase.auth() : null;
â€Žconst db = (window.firebase && typeof firebase.firestore === 'function') ? firebase.firestore() : null;
â€Ž
â€Ž// ====== DOM READY ======
â€Ždocument.addEventListener('DOMContentLoaded', () => {
â€Ž
â€Ž// ====== ELEMENTS (guarded) ======Â  
â€Žconst adsGrid = document.getElementById('adsGrid');Â  
â€Žconst statClicked = document.getElementById('statClicked');Â  
â€Žconst statCompleted = document.getElementById('statCompleted');Â  
â€Žconst statAbandoned = document.getElementById('statAbandoned');Â  
â€Žconst statIncome = document.getElementById('statIncome');Â  
â€Žconst statAdTotal = document.getElementById('statAdTotal');Â  
â€Ž
â€Žconst adModal = document.getElementById('adModal');Â  
â€Žconst adPlayer = document.getElementById('adPlayer'); // <video>Â  
â€Žconst closeAd = document.getElementById('closeAd');Â  
â€Ž
â€Žif (!adsGrid || !adModal || !adPlayer) {Â  
â€ŽÂ  console.warn('Watch Ads: required DOM elements missing. Script will not run fully.');Â  
â€ŽÂ  return;Â  
â€Ž}Â  
â€Ž
â€Ž// create a fallback message area inside modal for cases when no ad is availableÂ  
â€Žlet adFallbackMsg = document.getElementById('adFallbackMessage');Â  
â€Žif (!adFallbackMsg) {Â  
â€ŽÂ  adFallbackMsg = document.createElement('div');Â  
â€ŽÂ  adFallbackMsg.id = 'adFallbackMessage';Â  
â€ŽÂ  adFallbackMsg.style.padding = '12px 18px';Â  
â€ŽÂ  adFallbackMsg.style.display = 'none';Â  
â€ŽÂ  adFallbackMsg.style.textAlign = 'center';Â  
â€ŽÂ  adFallbackMsg.style.color = '#0f172a';Â  
â€ŽÂ  adFallbackMsg.style.fontSize = '14px';Â  
â€ŽÂ  adFallbackMsg.className = 'animate-fadeIn';Â  
â€ŽÂ  // insert before videoÂ  
â€ŽÂ  const videoWrap = adPlayer.parentElement;Â  
â€ŽÂ  videoWrap.insertBefore(adFallbackMsg, adPlayer);Â  
â€Ž}Â  
â€Ž
â€Ž// ====== STATE ======Â  
â€Žlet currentUser = null;Â  
â€Žlet inProgress = {};Â Â Â Â Â  // cardId -> booleanÂ  
â€Žlet cardStatus = {};Â Â Â Â Â  // cardId -> 'available' | 'completed' | 'abandoned'Â  
â€Žlet userStats = { adsClicked: 0, adsCompleted: 0, adsAbandoned: 0, balance: 0, adEarningsToday: 0, adEarningsTotal: 0 };Â  
â€Žlet currentPlayingCard = null;Â  
â€Žlet hlsLoaded = false;Â  
â€Ž
â€Ž// ====== UTIL ======Â  
â€Žfunction formatNaira(v) { return 'â‚¦' + Number(v).toFixed(2); }Â  
â€Žfunction todayString() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }Â  
â€Žfunction formatTime(t) {Â  
â€ŽÂ  if (!isFinite(t) || t <= 0) return '00:00';Â  
â€ŽÂ  t = Math.floor(t);Â  
â€ŽÂ  const m = Math.floor(t / 60);Â  
â€ŽÂ  const s = t % 60;Â  
â€ŽÂ  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;Â  
â€Ž}Â  
â€Ž
â€Ž// ====== RENDER CARDS ======Â  
â€Žfunction renderCards() {Â  
â€ŽÂ  adsGrid.innerHTML = '';Â  
â€ŽÂ  for (let i = 1; i <= NUM_CARDS; i++) {Â  
â€ŽÂ Â Â  const status = cardStatus[i] || 'available';Â  
â€ŽÂ Â Â  const disabled = (status === 'completed' || status === 'abandoned');Â  
â€ŽÂ Â Â  const card = document.createElement('div');Â  
â€ŽÂ Â Â  card.dataset.cardId = i;Â  
â€ŽÂ Â Â  card.className = `relative group rounded-2xl p-4 bg-white/80 backdrop-blur border border-indigo-100 ${disabled ? 'opacity-60 pointer-events-none' : 'hover:-translate-y-1 hover:shadow-lg transition'}`;Â  
â€ŽÂ Â Â  card.innerHTML = `Â  
â€ŽÂ Â Â Â Â  <div class="flex items-start gap-4">Â  
â€ŽÂ Â Â Â Â Â Â  <div class="w-14 h-14 rounded-xl overflow-hidden">Â  
â€ŽÂ Â Â Â Â Â Â Â Â  <img src="GLOBALS.jpg" alt="globals" class="w-full h-full object-cover">Â  
â€ŽÂ Â Â Â Â Â Â  </div>Â  
â€ŽÂ Â Â Â Â Â Â  <div class="flex-1">Â  
â€ŽÂ Â Â Â Â Â Â Â Â  <div class="flex items-center justify-between">Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â  <div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â  <div class="text-sm font-semibold text-slate-900">Global Ad #${i}</div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â  <div class="text-xs text-slate-500 mt-0.5">Watch video to earn</div>
â€Ž
â€Ž</div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="text-right">Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="text-sm font-semibold text-emerald-600">${formatNaira(REWARD_NAIRA)}</div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="text-xs text-slate-400">Globals Ads</div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â  </div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â  <div class="mt-3 flex items-center gap-2">Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button class="watch-btn inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-xl text-sm" aria-label="Watch Ad ${i}">Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <i data-lucide="play" class="w-4 h-4"></i>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  WatchÂ  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </button>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="status-pill ml-2 text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">${status === 'available' ? 'Available' : (status === 'completed' ? 'Completed' : 'Skipped')}</div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â Â Â  </div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â Â Â  </div>Â  
â€ŽÂ Â Â Â Â Â Â Â Â  </div>Â  
â€ŽÂ Â Â Â Â Â Â  `;Â  
â€ŽÂ Â Â Â Â Â Â  adsGrid.appendChild(card);Â  
â€ŽÂ Â Â Â Â  }Â  
â€ŽÂ Â Â Â Â  // render lucide icons if availableÂ  
â€ŽÂ Â Â Â Â  setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 30);Â  
â€ŽÂ Â Â  }Â  // ====== FIRESTORE / FALLBACK HELPERS ======Â  
â€Žasync function ensureUserDoc(uid) {Â  
â€ŽÂ  if (!db) {Â  
â€ŽÂ Â Â  // local fallbackÂ  
â€ŽÂ Â Â  const key = `watched_user_${uid}`;Â  
â€ŽÂ Â Â  const raw = localStorage.getItem(key);Â  
â€ŽÂ Â Â  if (!raw) {Â  
â€ŽÂ Â Â Â Â  const obj = { balance: 0, adEarningsToday: 0, adEarningsTotal: 0, adsClicked: 0, adsCompleted: 0, adsAbandoned: 0, watchedAds: {}, lastDailyReset: todayString() };Â  
â€ŽÂ Â Â Â Â  localStorage.setItem(key, JSON.stringify(obj));Â  
â€ŽÂ Â Â Â Â  return obj;Â  
â€ŽÂ Â Â  }Â  
â€ŽÂ Â Â  return JSON.parse(raw);Â  
â€ŽÂ  }Â  
â€ŽÂ  const docRef = db.collection('users').doc(uid);Â  
â€ŽÂ  const doc = await docRef.get();Â  
â€ŽÂ  const today = todayString();Â  
â€ŽÂ  if (!doc.exists) {Â  
â€ŽÂ Â Â  await docRef.set({ balance: 0, adEarningsToday: 0, adEarningsTotal: 0, adsClicked: 0, adsCompleted: 0, adsAbandoned: 0, watchedAds: {}, lastDailyReset: today });Â  
â€ŽÂ Â Â  return { balance: 0, adEarningsToday: 0, adEarningsTotal: 0, adsClicked: 0, adsCompleted: 0, adsAbandoned: 0, watchedAds: {}, lastDailyReset: today };Â  
â€ŽÂ  }Â  
â€ŽÂ  return doc.data();Â  
â€Ž}Â  
â€Ž
â€Žasync function dailyResetIfNeeded(uid, userDoc) {Â  
â€ŽÂ  const today = todayString();Â  
â€ŽÂ  if (!userDoc) return;Â  
â€ŽÂ  const last = userDoc.lastDailyReset || '';Â  
â€ŽÂ  if (last !== today) {Â  
â€ŽÂ Â Â  if (db) {Â  
â€ŽÂ Â Â Â Â  await db.collection('users').doc(uid).set({ watchedAds: {}, lastDailyReset: today, adEarningsToday: 0 }, { merge: true });Â  
â€ŽÂ Â Â  } else {Â  
â€ŽÂ Â Â Â Â  // local fallbackÂ  
â€ŽÂ Â Â Â Â  const key = `watched_user_${uid}`;Â  
â€ŽÂ Â Â Â Â  const raw = localStorage.getItem(key) || '{}';Â  
â€ŽÂ Â Â Â Â  const obj = JSON.parse(raw);Â  
â€ŽÂ Â Â Â Â  obj.watchedAds = {};Â  
â€ŽÂ Â Â Â Â  obj.lastDailyReset = today;Â  
â€ŽÂ Â Â Â Â  obj.adEarningsToday = 0;Â  
â€ŽÂ Â Â Â Â  localStorage.setItem(key, JSON.stringify(obj));Â  
â€ŽÂ Â Â  }Â  
â€ŽÂ Â Â  cardStatus = {};Â  
â€ŽÂ Â Â  renderCards();Â  
â€ŽÂ  }Â  
â€Ž}Â  
â€Ž
â€Žasync function loadUserData(uid) {Â  
â€ŽÂ  try {Â  
â€ŽÂ Â Â  const docSnap = db ? await db.collection('users').doc(uid).get() : null;Â  
â€ŽÂ Â Â  let data = docSnap && docSnap.exists ? docSnap.data() : await ensureUserDoc(uid);Â  
â€ŽÂ Â Â  await dailyResetIfNeeded(uid, data);Â  
â€Ž
â€ŽÂ Â Â  const fresh = db ? (await db.collection('users').doc(uid).get()).data() : JSON.parse(localStorage.getItem(`watched_user_${uid}`) || '{}');Â  
â€Ž
â€ŽÂ Â Â  // defensive mappingÂ  
â€ŽÂ Â Â  userStats.adsClicked = fresh.adsClicked || 0;Â  
â€ŽÂ Â Â  userStats.adsCompleted = fresh.adsCompleted || 0;Â  
â€ŽÂ Â Â  userStats.adsAbandoned = fresh.adsAbandoned || 0;Â  
â€ŽÂ Â Â  userStats.balance = fresh.balance || 0;Â  
â€ŽÂ Â Â  userStats.adEarningsToday = (typeof fresh.adEarningsToday !== 'undefined') ? fresh.adEarningsToday : (typeof fresh.adEarnings !== 'undefined' ? fresh.adEarnings : 0);Â  
â€ŽÂ Â Â  userStats.adEarningsTotal = (typeof fresh.adEarningsTotal !== 'undefined') ? fresh.adEarningsTotal : (typeof fresh.adEarnings !== 'undefined' ? fresh.adEarnings : 0);Â  
â€Ž
â€ŽÂ Â Â  // watchedAds -> cardStatus
â€Ž
â€ŽcardStatus = {};
â€Žconst watched = fresh.watchedAds || {};
â€ŽObject.keys(watched).forEach(k => {
â€Žconst id = Number(k);
â€Žif (id >= 1 && id <= NUM_CARDS) cardStatus[id] = watched[k];
â€Ž});
â€Ž
â€ŽupdateStatsUI();Â  
â€ŽÂ Â Â  renderCards();Â  
â€Ž
â€ŽÂ Â Â  // process in-progress flag left from previous loadÂ  
â€ŽÂ Â Â  const inProg = localStorage.getItem('ad_in_progress');Â  
â€ŽÂ Â Â  if (inProg) {Â  
â€ŽÂ Â Â Â Â  const cid = Number(inProg);Â  
â€ŽÂ Â Â Â Â  if (cid >= 1 && cid <= NUM_CARDS && (!cardStatus[cid] || cardStatus[cid] === 'available')) {Â  
â€ŽÂ Â Â Â Â Â Â  try { await recordAbandoned(uid, cid); } catch (err) { console.warn('failed mark abandoned on load', err); }Â  
â€ŽÂ Â Â Â Â  }Â  
â€ŽÂ Â Â Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ Â Â  }Â  
â€ŽÂ  } catch (err) {Â  
â€ŽÂ Â Â  console.error('loadUserData err', err);Â  
â€ŽÂ  }Â  
â€Ž}Â  
â€Ž
â€Žfunction updateStatsUI() {Â  
â€ŽÂ  if (statClicked) statClicked.textContent = userStats.adsClicked || 0;Â  
â€ŽÂ  if (statCompleted) statCompleted.textContent = userStats.adsCompleted || 0;Â  
â€ŽÂ  if (statAbandoned) statAbandoned.textContent = userStats.adsAbandoned || 0;Â  
â€ŽÂ  if (statIncome) statIncome.textContent = formatNaira(userStats.adEarningsToday || 0);Â  
â€ŽÂ  if (statAdTotal) statAdTotal.textContent = formatNaira(userStats.adEarningsTotal || 0);Â  
â€Ž}
â€Ž
â€Ž/* ====================== TOAST FUNCTION ====================== */
â€Žfunction showToast(message, type='success', duration=3000){
â€Žlet container = document.getElementById('toastContainer');
â€Žif(!container){
â€Žcontainer = document.createElement('div');
â€Žcontainer.id = 'toastContainer';
â€Žcontainer.className = 'fixed top-6 right-6 z-50 flex flex-col gap-2';
â€Ždocument.body.appendChild(container);
â€Ž}
â€Ž
â€Žconst toast = document.createElement('div');Â  
â€Žtoast.className = `Â  
â€ŽÂ Â Â  px-4 py-2 rounded-lg shadow-lg text-sm font-mediumÂ  
â€ŽÂ Â Â  ${type==='success'? 'bg-green-600 text-white':'bg-rose-500 text-white'}Â  
â€ŽÂ Â Â  animate-fadeInÂ  
â€Ž`;Â  
â€Žtoast.textContent = message;Â  
â€Žcontainer.appendChild(toast);Â  
â€Ž
â€ŽsetTimeout(() => { toast.remove(); }, duration);
â€Ž
â€Ž}
â€Ž
â€Ž/* ====================== WATCH ADS HELPERS ====================== */
â€Žasync function recordClickOnly(uid, cardId) {
â€Žif (db) {
â€Žawait db.collection('users').doc(uid).set({
â€ŽadsClicked: firebase.firestore.FieldValue.increment(1)
â€Ž}, { merge: true });
â€Ž} else {
â€Žconst key = watched_user_${uid};
â€Žconst obj = JSON.parse(localStorage.getItem(key) || '{}');
â€Žobj.adsClicked = (obj.adsClicked || 0) + 1;
â€ŽlocalStorage.setItem(key, JSON.stringify(obj));
â€Ž}
â€Ž
â€ŽuserStats.adsClicked++;
â€ŽupdateStatsUI();
â€Ž}
â€Ž
â€Žasync function recordAbandoned(uid, cardId) {
â€Žconst field = watchedAds.${cardId};
â€Žif (db) {
â€Žawait db.collection('users').doc(uid).set({
â€ŽadsAbandoned: firebase.firestore.FieldValue.increment(1),
â€Ž[field]: 'abandoned'
â€Ž}, { merge: true });
â€Ž} else {
â€Žconst key = watched_user_${uid};
â€Žconst obj = JSON.parse(localStorage.getItem(key) || '{}');
â€Žobj.adsAbandoned = (obj.adsAbandoned || 0) + 1;
â€Žobj.watchedAds = obj.watchedAds || {};
â€Žobj.watchedAds[cardId] = 'abandoned';
â€ŽlocalStorage.setItem(key, JSON.stringify(obj));
â€Ž}
â€Ž
â€ŽuserStats.adsAbandoned++;
â€ŽcardStatus[cardId] = 'abandoned';
â€ŽupdateStatsUI();
â€ŽrenderCards();
â€Ž
â€Ž// Show toast when ad is skipped
â€ŽshowToast('âš ï¸ Ad skipped â€” no reward', 'error');
â€Ž}
â€Ž
â€Žasync function rewardUser(uid, cardId) {
â€Žconst field = watchedAds.${cardId};
â€Žif (db) {
â€Žawait db.collection('users').doc(uid).set({
â€Žbalance: firebase.firestore.FieldValue.increment(REWARD_NAIRA),
â€ŽadEarningsToday: firebase.firestore.FieldValue.increment(REWARD_NAIRA),
â€ŽadEarningsTotal: firebase.firestore.FieldValue.increment(REWARD_NAIRA),
â€ŽadsCompleted: firebase.firestore.FieldValue.increment(1),
â€Ž[field]: 'completed'
â€Ž}, { merge: true });
â€Ž} else {
â€Žconst key = watched_user_${uid};
â€Žconst obj = JSON.parse(localStorage.getItem(key) || '{}');
â€Žobj.balance = (obj.balance || 0) + REWARD_NAIRA;
â€Žobj.adEarningsToday = (obj.adEarningsToday || 0) + REWARD_NAIRA;
â€Žobj.adEarningsTotal = (obj.adEarningsTotal || 0) + REWARD_NAIRA;
â€Žobj.adsCompleted = (obj.adsCompleted || 0) + 1;
â€Žobj.watchedAds = obj.watchedAds || {};
â€Žobj.watchedAds[cardId] = 'completed';
â€ŽlocalStorage.setItem(key, JSON.stringify(obj));
â€Ž}
â€Ž
â€ŽuserStats.balance = (Number(userStats.balance) || 0) + Number(REWARD_NAIRA);
â€ŽuserStats.adEarningsToday = (Number(userStats.adEarningsToday) || 0) + Number(REWARD_NAIRA);
â€ŽuserStats.adEarningsTotal = (Number(userStats.adEarningsTotal) || 0) + Number(REWARD_NAIRA);
â€ŽuserStats.adsCompleted++;
â€ŽcardStatus[cardId] = 'completed';
â€ŽupdateStatsUI();
â€ŽrenderCards();
â€Ž
â€Ž// Show toast when reward is earned
â€ŽshowToast(ðŸŽ‰ You earned â‚¦${REWARD_NAIRA} added to your balance!, 'success');
â€Ž}
â€Ž
â€Ž// ====== VAST RESOLUTION & HLS LOAD ======Â  
â€Žasync function fetchText(url) {Â  
â€ŽÂ  const res = await fetch(url, { method: 'GET', mode: 'cors' });Â  
â€ŽÂ  if (!res.ok) throw new Error('fetch failed ' + res.status);Â  
â€ŽÂ  return res.text();Â  
â€Ž}Â  
â€Žfunction parseXML(text) {Â  
â€ŽÂ  try { return (new DOMParser()).parseFromString(text, 'application/xml'); } catch (e) { return null; }Â  
â€Ž}Â  
â€Žasync function resolveVast(url, depth = 0) {Â  
â€ŽÂ  if (!url || depth > 3) return null;Â  
â€ŽÂ  try {Â  
â€ŽÂ Â Â  const text = await fetchText(url);Â  
â€ŽÂ Â Â  const xml = parseXML(text);Â  
â€ŽÂ Â Â  if (!xml) return null;Â  
â€ŽÂ Â Â  const wrapper = xml.querySelector('Wrapper > VASTAdTagURI, VASTAdTagURI');Â  
â€ŽÂ Â Â  if (wrapper && wrapper.textContent && wrapper.textContent.trim()) {Â  
â€ŽÂ Â Â Â Â  const next = wrapper.textContent.trim();Â  
â€ŽÂ Â Â Â Â  return await resolveVast(next, depth + 1);Â  
â€ŽÂ Â Â  }Â  
â€ŽÂ Â Â  const mediaFiles = Array.from(xml.querySelectorAll('MediaFile'))Â  
â€ŽÂ Â Â Â Â  .map(node => ({ url: (node.textContent || '').trim(), type: node.getAttribute('type') || '' }))Â  
â€ŽÂ Â Â Â Â  .filter(m => m.url && !/javascript|vpaid/i.test(m.url));Â  
â€ŽÂ Â Â  const mp4 = mediaFiles.find(c => /mp4|video\/mp4/i.test(c.type) || /\.mp4(\?|$)/i.test(c.url));Â  
â€ŽÂ Â Â  if (mp4) return { kind: 'mp4', url: mp4.url };Â  
â€ŽÂ Â Â  const hls = mediaFiles.find(c => /\.m3u8(\?|$)/i.test(c.url) || /application\/x-mpegURL/i.test(c.type));Â  
â€ŽÂ Â Â  if (hls) return { kind: 'hls', url: hls.url };Â  
â€ŽÂ Â Â  return null;Â  
â€ŽÂ  } catch (e) {Â  
â€ŽÂ Â Â  console.warn('resolveVast err', e);Â  
â€ŽÂ Â Â  return null;Â  
â€ŽÂ  }Â  
â€Ž}Â  
â€Žfunction loadHlsJs() {Â  
â€ŽÂ  return new Promise((resolve, reject) => {Â  
â€ŽÂ Â Â  if (hlsLoaded) return resolve(window.Hls);Â  
â€ŽÂ Â Â  const s = document.createElement('script');Â  
â€ŽÂ Â Â  s.src = HLS_JS_SRC;Â  
â€ŽÂ Â Â  s.onload = () => { hlsLoaded = true; resolve(window.Hls); };Â  
â€ŽÂ Â Â  s.onerror = reject;Â  
â€ŽÂ Â Â  document.head.appendChild(s);Â  
â€ŽÂ  });Â  
â€Ž
â€Ž}Â  
â€Ž
â€Ž// ====== NO-SEEK PROTECTION + PROGRESS UI ======Â  
â€Žlet modalKeyBlockHandler = null;Â  
â€Žfunction blockModalSeekKeys() {Â  
â€ŽÂ  modalKeyBlockHandler = (e) => {Â  
â€ŽÂ Â Â  const blocked = ['ArrowLeft', 'ArrowRight', 'Home', 'End', 'PageUp', 'PageDown'];Â  
â€ŽÂ Â Â  if (blocked.includes(e.code)) e.preventDefault();Â  
â€ŽÂ  };Â  
â€ŽÂ  window.addEventListener('keydown', modalKeyBlockHandler, { capture: true });Â  
â€Ž}Â  
â€Žfunction unblockModalSeekKeys() {Â  
â€ŽÂ  if (modalKeyBlockHandler) { window.removeEventListener('keydown', modalKeyBlockHandler, { capture: true }); modalKeyBlockHandler = null; }Â  
â€Ž}Â  
â€Ž
â€Žfunction updateProgress(video) {Â  
â€ŽÂ  const progressEl = document.getElementById('videoProgress');Â  
â€ŽÂ  const label = document.getElementById('videoTimeLabel');Â  
â€ŽÂ  const rem = document.getElementById('videoRemainingLabel');Â  
â€ŽÂ  if (!label) return;Â  
â€ŽÂ  const dur = isFinite(video.duration) ? video.duration : 0;Â  
â€ŽÂ  const cur = isFinite(video.currentTime) ? video.currentTime : 0;Â  
â€ŽÂ  const pct = dur > 0 ? Math.min(100, Math.max(0, (cur / dur) * 100)) : 0;Â  
â€ŽÂ  if (progressEl) progressEl.style.width = pct + '%';Â  
â€ŽÂ  label.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;Â  
â€ŽÂ  if (rem) rem.textContent = dur > 0 ? `-${formatTime(Math.max(0, dur - cur))}` : '';Â  
â€Ž}Â  
â€Ž
â€Žfunction attachNoSeekProtection(video) {Â  
â€ŽÂ  let lastTime = 0;Â  
â€ŽÂ  const onTime = () => { lastTime = Math.max(lastTime, video.currentTime); updateProgress(video); };Â  
â€ŽÂ  const onSeeking = () => { if (Math.abs(video.currentTime - lastTime) > 0.2) video.currentTime = lastTime; };Â  
â€ŽÂ  const onLoaded = () => { updateProgress(video); };Â  
â€ŽÂ  const onContext = (e) => e.preventDefault();Â  
â€ŽÂ  video.addEventListener('timeupdate', onTime);Â  
â€ŽÂ  video.addEventListener('seeking', onSeeking);Â  
â€ŽÂ  video.addEventListener('loadedmetadata', onLoaded);Â  
â€ŽÂ  video.addEventListener('contextmenu', onContext);Â  
â€ŽÂ  blockModalSeekKeys();Â  
â€ŽÂ  return () => {Â  
â€ŽÂ Â Â  video.removeEventListener('timeupdate', onTime);Â  
â€ŽÂ Â Â  video.removeEventListener('seeking', onSeeking);Â  
â€ŽÂ Â Â  video.removeEventListener('loadedmetadata', onLoaded);Â  
â€ŽÂ Â Â  video.removeEventListener('contextmenu', onContext);Â  
â€ŽÂ Â Â  unblockModalSeekKeys();Â  
â€ŽÂ  };Â  
â€Ž}Â  
â€Ž
â€Ž// ====== HANDLE WATCH CLICK ======Â  
â€Žasync function handleWatchClick(cardId, cardEl) {Â  
â€ŽÂ  try {Â  
â€ŽÂ Â Â  if (!auth || !auth.currentUser) { alert('Please sign in to watch ads and earn.'); return; }Â  
â€ŽÂ Â Â  if (inProgress[cardId]) return;Â  
â€ŽÂ Â Â  if (cardStatus[cardId] === 'completed' || cardStatus[cardId] === 'abandoned') return;Â  
â€Ž
â€ŽÂ Â Â  // stateÂ  
â€ŽÂ Â Â  inProgress[cardId] = true;Â  
â€ŽÂ Â Â  currentPlayingCard = cardId;Â  
â€ŽÂ Â Â  try { localStorage.setItem('ad_in_progress', String(cardId)); } catch (e) { }Â  
â€Ž
â€ŽÂ Â Â  // record clickÂ  
â€ŽÂ Â Â  try { await recordClickOnly(auth.currentUser.uid, cardId); } catch (e) { console.warn('recordClickOnly failed', e); }Â  
â€Ž
â€ŽÂ Â Â  // modal UIÂ  
â€ŽÂ Â Â  adFallbackMsg.style.display = 'none';Â  
â€ŽÂ Â Â  adPlayer.style.display = 'block';Â  
â€ŽÂ Â Â  adPlayer.pause();Â  
â€ŽÂ Â Â  // ensure adPlayer has no native controlsÂ  
â€ŽÂ Â Â  adPlayer.removeAttribute('controls');Â  
â€ŽÂ Â Â  adPlayer.setAttribute('playsinline', ''); // mobile inlineÂ  
â€ŽÂ Â Â  try { adPlayer.removeAttribute('controlsList'); } catch (_) { }Â  
â€ŽÂ Â Â  // hide poster, clear srcÂ  
â€ŽÂ Â Â  adPlayer.removeAttribute('poster');Â  
â€ŽÂ Â Â  adPlayer.src = '';Â  
â€ŽÂ Â Â  // reset progress labels immediatelyÂ  
â€ŽÂ Â Â  const progressEl = document.getElementById('videoProgress'); if (progressEl) progressEl.style.width = '0%';Â  
â€ŽÂ Â Â  const timeLabel = document.getElementById('videoTimeLabel'); if (timeLabel) timeLabel.textContent = '00:00 / 00:00';Â  
â€ŽÂ Â Â  const remLabel = document.getElementById('videoRemainingLabel'); if (remLabel) remLabel.textContent = '';Â  
â€Ž
â€ŽÂ Â Â  adModal.classList.remove('hidden');Â  
â€Ž
â€ŽÂ Â Â  // resolve VAST to get playable mediaÂ  
â€ŽÂ Â Â  let resolved = null;Â  
â€ŽÂ Â Â  try { resolved = await resolveVast(VAST_LINK); } catch (e) { resolved = null; }
â€Ž
â€Žif (!resolved) {
â€Ž// NO redirect: show friendly message and allow retry/close
â€ŽadPlayer.style.display = 'none';
â€ŽadFallbackMsg.textContent = 'No playable ad available right now. Try again later.';
â€ŽadFallbackMsg.style.display = 'block';
â€ŽinProgress[cardId] = false;
â€ŽcurrentPlayingCard = null;
â€ŽlocalStorage.removeItem('ad_in_progress');
â€Žreturn;
â€Ž}
â€Ž
â€Ž// setup protection + playbackÂ  
â€ŽÂ Â Â  const cleanup = attachNoSeekProtection(adPlayer);Â  
â€Ž
â€ŽÂ Â Â  // allow longer buffering in slow networks: 15 seconds before showing fallbackÂ  
â€ŽÂ Â Â  const failTimeout = setTimeout(() => {Â  
â€ŽÂ Â Â Â Â  if (adPlayer.readyState === 0) {Â  
â€ŽÂ Â Â Â Â Â Â  cleanup();Â  
â€ŽÂ Â Â Â Â Â Â  adPlayer.style.display = 'none';Â  
â€ŽÂ Â Â Â Â Â Â  adFallbackMsg.textContent = 'Failed to load ad (slow connection). Please try again.';Â  
â€ŽÂ Â Â Â Â Â Â  adFallbackMsg.style.display = 'block';Â  
â€ŽÂ Â Â Â Â Â Â  adModal.classList.remove('hidden');Â  
â€ŽÂ Â Â Â Â Â Â  inProgress[cardId] = false;Â  
â€ŽÂ Â Â Â Â Â Â  currentPlayingCard = null;Â  
â€ŽÂ Â Â Â Â Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ Â Â Â Â  }Â  
â€ŽÂ Â Â  }, 15000);Â  
â€Ž
â€ŽÂ Â Â  // play pathsÂ  
â€ŽÂ Â Â  if (resolved.kind === 'mp4') {Â  
â€ŽÂ Â Â Â Â  adPlayer.src = resolved.url;Â  
â€ŽÂ Â Â Â Â  adPlayer.load();Â  
â€ŽÂ Â Â Â Â  try {Â  
â€ŽÂ Â Â Â Â Â Â  await adPlayer.play();Â  
â€ŽÂ Â Â Â Â  } catch (err) {Â  
â€ŽÂ Â Â Â Â Â Â  // play failed (rare if user gesture), but keep modal open and show messageÂ  
â€ŽÂ Â Â Â Â Â Â  console.warn('adPlayer.play() failed', err);Â  
â€ŽÂ Â Â Â Â  }Â  
â€ŽÂ Â Â Â Â  adPlayer.onended = async () => {Â  
â€ŽÂ Â Â Â Â Â Â  clearTimeout(failTimeout);Â  
â€ŽÂ Â Â Â Â Â Â  cleanup();Â  
â€ŽÂ Â Â Â Â Â Â  adModal.classList.add('hidden');Â  
â€ŽÂ Â Â Â Â Â Â  try { await rewardUser(auth.currentUser.uid, cardId); } catch (e) { console.error('rewardUser err', e); }Â  
â€ŽÂ Â Â Â Â Â Â  inProgress[cardId] = false;Â  
â€ŽÂ Â Â Â Â Â Â  currentPlayingCard = null;Â  
â€ŽÂ Â Â Â Â Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ Â Â Â Â  };Â  
â€ŽÂ Â Â  } else if (resolved.kind === 'hls') {Â  
â€ŽÂ Â Â Â Â  const Hls = await loadHlsJs().catch(() => null);Â  
â€ŽÂ Â Â Â Â  if (Hls && Hls.isSupported()) {Â  
â€ŽÂ Â Â Â Â Â Â  const hls = new Hls();Â  
â€ŽÂ Â Â Â Â Â Â  hls.loadSource(resolved.url);Â  
â€ŽÂ Â Â Â Â Â Â  hls.attachMedia(adPlayer);Â  
â€ŽÂ Â Â Â Â Â Â  adPlayer.load();Â  
â€ŽÂ Â Â Â Â Â Â  try { await adPlayer.play(); } catch (err) { /* ignore play error */ }Â  
â€ŽÂ Â Â Â Â Â Â  adPlayer.onended = async () => {Â  
â€ŽÂ Â Â Â Â Â Â Â Â  clearTimeout(failTimeout);Â  
â€ŽÂ Â Â Â Â Â Â Â Â  cleanup();Â  
â€ŽÂ Â Â Â Â Â Â Â Â  adModal.classList.add('hidden');Â  
â€ŽÂ Â Â Â Â Â Â Â Â  try { await rewardUser(auth.currentUser.uid, cardId); } catch (e) { console.error('rewardUser err', e); }Â  
â€ŽÂ Â Â Â Â Â Â Â Â  inProgress[cardId] = false;Â  
â€ŽÂ Â Â Â Â Â Â Â Â  currentPlayingCard = null;Â  
â€ŽÂ Â Â Â Â Â Â Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ Â Â Â Â Â Â  };Â  
â€ŽÂ Â Â Â Â  } else {Â  
â€ŽÂ Â Â Â Â Â Â  // HLS lib not available or unsupportedÂ  
â€ŽÂ Â Â Â Â Â Â  clearTimeout(failTimeout);Â  
â€ŽÂ Â Â Â Â Â Â  cleanup();Â  
â€ŽÂ Â Â Â Â Â Â  adPlayer.style.display = 'none';Â  
â€ŽÂ Â Â Â Â Â Â  adFallbackMsg.textContent = 'Video format not supported by your browser.';Â  
â€ŽÂ Â Â Â Â Â Â  adFallbackMsg.style.display = 'block';Â  
â€ŽÂ Â Â Â Â Â Â  inProgress[cardId] = false;Â  
â€ŽÂ Â Â Â Â Â Â  currentPlayingCard = null;Â  
â€ŽÂ Â Â Â Â Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ Â Â Â Â  }Â  
â€ŽÂ Â Â  } else {Â  
â€ŽÂ Â Â Â Â  clearTimeout(failTimeout);Â  
â€ŽÂ Â Â Â Â  cleanup();Â  
â€ŽÂ Â Â Â Â  adPlayer.style.display = 'none';Â  
â€ŽÂ Â Â Â Â  adFallbackMsg.textContent = 'Unsupported ad format.';Â  
â€ŽÂ Â Â Â Â  adFallbackMsg.style.display = 'block';Â  
â€ŽÂ Â Â Â Â  inProgress[cardId] = false;Â  
â€ŽÂ Â Â Â Â  currentPlayingCard = null;Â  
â€ŽÂ Â Â Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ Â Â  }
â€Ž
â€Ž} catch (err) {
â€Žconsole.error('handleWatchClick err', err);
â€Ž// best effort cleanup
â€Žtry { adPlayer.pause(); } catch (e) { /* ignore */ }
â€ŽadModal.classList.add('hidden');
â€ŽinProgress[cardId] = false;
â€ŽcurrentPlayingCard = null;
â€ŽlocalStorage.removeItem('ad_in_progress');
â€Ž}
â€Ž}
â€Ž
â€Ž// ====== CLOSE MODAL HANDLER ======Â  
â€ŽcloseAd.addEventListener('click', async () => {Â  
â€ŽÂ  if (currentPlayingCard && auth && auth.currentUser) {Â  
â€ŽÂ Â Â  try { await recordAbandoned(auth.currentUser.uid, Number(currentPlayingCard)); } catch (e) { console.warn(e); }Â  
â€ŽÂ  }Â  
â€ŽÂ  try { adPlayer.pause(); } catch (e) { /* ignore */ }Â  
â€ŽÂ  adModal.classList.add('hidden');Â  
â€ŽÂ  if (currentPlayingCard) inProgress[currentPlayingCard] = false;Â  
â€ŽÂ  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ  currentPlayingCard = null;Â  
â€ŽÂ  // reset progress visualsÂ  
â€ŽÂ  const progressEl = document.getElementById('videoProgress'); if (progressEl) progressEl.style.width = '0%';Â  
â€ŽÂ  const timeLabel = document.getElementById('videoTimeLabel'); if (timeLabel) timeLabel.textContent = '00:00 / 00:00';Â  
â€ŽÂ  const remLabel = document.getElementById('videoRemainingLabel'); if (remLabel) remLabel.textContent = '';Â  
â€ŽÂ  adFallbackMsg.style.display = 'none';Â  
â€Ž});Â  
â€Ž
â€Ž// ====== BUTTON DELEGATION ON GRID ======Â  
â€ŽadsGrid.addEventListener('click', (e) => {Â  
â€ŽÂ  const btn = e.target.closest('.watch-btn'); if (!btn) return;Â  
â€ŽÂ  const cardEl = e.target.closest('[data-card-id]'); if (!cardEl) return;Â  
â€ŽÂ  const cardId = Number(cardEl.dataset.cardId);Â  
â€ŽÂ  if (btn.disabled) return;Â  
â€ŽÂ  btn.setAttribute('disabled', 'true');Â  
â€ŽÂ  setTimeout(() => btn.removeAttribute('disabled'), 900);Â  
â€ŽÂ  handleWatchClick(cardId, cardEl);Â  
â€Ž});Â  
â€Ž
â€Ž// ====== PROCESS IN-PROGRESS ON LOAD ======Â  
â€Žasync function processInProgressOnLoad() {Â  
â€ŽÂ  try {Â  
â€ŽÂ Â Â  const inProg = localStorage.getItem('ad_in_progress');Â  
â€ŽÂ Â Â  if (!inProg) return;Â  
â€ŽÂ Â Â  const cid = Number(inProg);Â  
â€ŽÂ Â Â  if (!auth || !auth.currentUser) return;Â  
â€ŽÂ Â Â  // if that ad hasn't already been recorded, mark abandonedÂ  
â€ŽÂ Â Â  if (db) {Â  
â€ŽÂ Â Â Â Â  const doc = await db.collection('users').doc(auth.currentUser.uid).get();Â  
â€ŽÂ Â Â Â Â  const watched = (doc.exists && doc.data().watchedAds) ? doc.data().watchedAds : {};Â  
â€ŽÂ Â Â Â Â  if (!watched || !watched[cid]) await recordAbandoned(auth.currentUser.uid, cid);Â  
â€ŽÂ Â Â  } else {Â  
â€ŽÂ Â Â Â Â  // local fallbackÂ  
â€ŽÂ Â Â Â Â  const key = `watched_user_${auth.currentUser.uid}`;Â  
â€ŽÂ Â Â Â Â  const obj = JSON.parse(localStorage.getItem(key) || '{}');Â  
â€ŽÂ Â Â Â Â  const watched = obj.watchedAds || {};Â  
â€ŽÂ Â Â Â Â  if (!watched || !watched[cid]) await recordAbandoned(auth.currentUser.uid, cid);Â  
â€ŽÂ Â Â  }Â  
â€ŽÂ Â Â  localStorage.removeItem('ad_in_progress');Â  
â€ŽÂ  } catch (e) { console.warn('processInProgressOnLoad err', e); }Â  
â€Ž}Â  
â€Ž
â€Ž// ====== AUTH WATCHER ======Â  
â€Žif (auth) {Â  
â€ŽÂ  auth.onAuthStateChanged(async (u) => {Â  
â€ŽÂ Â Â  currentUser = u;Â  
â€ŽÂ Â Â  if (u) {Â  
â€ŽÂ Â Â Â Â  await loadUserData(u.uid);Â  
â€ŽÂ Â Â Â Â  await processInProgressOnLoad();Â  
â€ŽÂ Â Â  } else {Â  
â€ŽÂ Â Â Â Â  // guest fallbackÂ  
â€ŽÂ Â Â Â Â  userStats = { adsClicked: 0, adsCompleted: 0, adsAbandoned: 0, balance: 0, adEarningsToday: 0, adEarningsTotal: 0 };Â  
â€ŽÂ Â Â Â Â  try {Â  
â€ŽÂ Â Â Â Â Â Â  cardStatus = JSON.parse(localStorage.getItem('watchedAdsFallback') || '{}') || {};Â  
â€ŽÂ Â Â Â Â  } catch (e) { cardStatus = {}; }Â  
â€ŽÂ Â Â Â Â  updateStatsUI();Â  
â€ŽÂ Â Â Â Â  renderCards();Â  
â€ŽÂ Â Â  }Â  
â€ŽÂ  });Â  
â€Ž} else {
â€Ž
â€Ž// No Firebase: load fallback state from localStorage (optional)
â€Žtry {
â€Žconst fallback = JSON.parse(localStorage.getItem('watchedAdsFallback') || '{}') || {};
â€ŽcardStatus = fallback;
â€Ž} catch (_) { cardStatus = {}; }
â€ŽupdateStatsUI();
â€ŽrenderCards();
â€Ž}
â€Ž
â€Ž// ====== PERIODIC LOCAL FALLBACK SAVE ======Â  
â€ŽsetInterval(() => {Â  
â€ŽÂ  try { localStorage.setItem('watchedAdsFallback', JSON.stringify(cardStatus)); } catch (e) { /* ignore */ }Â  
â€Ž}, 5000);Â  
â€Ž
â€Ž// ====== INIT UI ======Â  
â€ŽrenderCards();Â  
â€ŽsetTimeout(() => { if (window.lucide) lucide.createIcons(); }, 50);Â  
â€Ž
â€Ž// expose a small API for debugging (optional)Â  
â€Žwindow.watchAdsDebug = {Â  
â€ŽÂ  renderCards,Â  
â€ŽÂ  loadUserData,Â  
â€ŽÂ  cardStatus,Â  
â€ŽÂ  userStats,Â  
â€ŽÂ  handleWatchClickÂ  
â€Ž};
â€Ž
â€Ž}); // DOMContentLoaded end
â€Ž
â€Ž})();
â€Ž
â€Ž
â€Ž</script>


</body>
</html>