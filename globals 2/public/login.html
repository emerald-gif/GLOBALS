<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login | Globals</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@0.278.0/dist/lucide.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .fade-in { animation: fadeIn .9s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(18px);} to { opacity:1; transform: translateY(0);} }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); }
    .error-text { font-size:.85rem; color:#dc2626; margin-top:6px; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-md mx-auto p-6 rounded-2xl shadow-xl glass fade-in">
    <div class="flex justify-center mb-4">
      <img src="VERIFIED.jpg" alt="Globals Logo" class="h-14 w-auto">
    </div>

    <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">Welcome Back 👋</h2>

    <form id="loginForm" class="space-y-4" method="POST" action="/login">
  
  <!-- Email / Username -->
  <div>
    <input 
      id="loginEmail" 
      name="username" 
      type="email" 
      autocomplete="username" 
      placeholder="Email" 
      class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500" 
      required
    >
    <p id="loginEmailError" class="error-text hidden">Please enter a valid email</p>
  </div>
  
  <!-- Password -->
  <div class="relative">
    <input 
      id="loginPassword" 
      name="password" 
      type="password" 
      autocomplete="current-password" 
      placeholder="Password" 
      class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500" 
      required
    >
    <button 
      type="button" 
      id="loginTogglePassword" 
      class="absolute inset-y-0 right-3 flex items-center text-gray-500" 
      aria-label="toggle password"
    >
      <i data-lucide="eye-off" class="w-5 h-5"></i>
    </button>
    <p id="loginPasswordError" class="error-text hidden">Password cannot be empty</p>
  </div>

  <!-- Forgot Password -->
  <div class="text-right">
    <a href="forgot-password.html" class="text-sm text-blue-600 hover:underline">Forgot password?</a>
  </div>

  <!-- Submit -->
  <button 
    type="submit" 
    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold text-lg"
  >
    Login
  </button>
</form>

    <p class="mt-4 text-center text-sm text-gray-600">
      Don’t have an account? <a href="signup.html" class="text-blue-600 hover:underline font-medium">Register here</a>
    </p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuI_Nw4HMbDWa6wR3FhHJMHOUgx53E40c",
      authDomain: "globals-17bf7.firebaseapp.com",
      projectId: "globals-17bf7",
      storageBucket: "globals-17bf7.appspot.com",
      messagingSenderId: "603274362994",
      appId: "1:603274362994:web:c312c10cf0a42938e882eb"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore(); // ✅ added Firestore
  </script>

  
  

<script>
document.addEventListener('DOMContentLoaded', () => {
  if (window.lucide) lucide.createIcons();

  const loginForm = document.getElementById('loginForm');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginEmailError = document.getElementById('loginEmailError');
  const loginPasswordError = document.getElementById('loginPasswordError');
  const loginTogglePassword = document.getElementById('loginTogglePassword');

  // same small UX helpers
  loginEmail.addEventListener('input', () => {
    loginEmailError.classList.toggle('hidden', loginEmail.validity.valid && loginEmail.value.trim() !== '');
  });
  loginPassword.addEventListener('input', () => {
    loginPasswordError.classList.toggle('hidden', loginPassword.value.trim() !== '');
  });
  loginTogglePassword.addEventListener('click', () => {
    const showing = loginPassword.type === 'text';
    loginPassword.type = showing ? 'password' : 'text';
    loginTogglePassword.innerHTML = showing
      ? '<i data-lucide="eye-off" class="w-5 h-5"></i>'
      : '<i data-lucide="eye" class="w-5 h-5"></i>';
    if (window.lucide) lucide.createIcons();
  });

  // centralized sign-in logic (uses firebase)
  async function handleSignIn(email, password, { allowStoreCredential = true } = {}) {
    try {
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    } catch (e) { console.warn('persistence:', e); }

    try {
      const userCred = await auth.signInWithEmailAndPassword(email, password);
      const uid = userCred.user.uid;
      const doc = await db.collection("users").doc(uid).get();
      if (!doc.exists) { alert('❌ User record not found.'); return; }
      const data = doc.data();
      if (!data.verified) {
        window.location.href = `verify.html?uid=${uid}&email=${encodeURIComponent(data.email)}`;
        return;
      }

      // store credential in browser password manager (prompt user to save)
      if (allowStoreCredential && navigator.credentials && navigator.credentials.store) {
        try {
          // PasswordCredential constructor is supported by some browsers; navigator.credentials.create can be used
          const credData = new PasswordCredential({ id: email, password });
          await navigator.credentials.store(credData);
          // In many browsers, calling store() triggers the "Save password?" snackbar.
        } catch (err) {
          // fallback: try create + store
          try {
            const cred = await navigator.credentials.create({ password: { id: email, password } });
            if (cred) await navigator.credentials.store(cred);
          } catch (e) {
            console.warn('credential store fallback failed', e);
          }
        }
      }

      // successful -> go to dashboard
      window.location.href = 'dashboard.html';
    } catch (err) {
      let msg = 'Login failed. Please try again.';
      if (err.code === 'auth/user-not-found') msg = 'No account found with this email.';
      else if (err.code === 'auth/wrong-password') msg = 'Incorrect password. Try again.';
      else if (err.code === 'auth/invalid-email') msg = 'Invalid email address.';
      alert('❌ ' + msg);
      console.error('Login failed:', err);
    }
  }

  // normal form submit
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginEmailError.classList.add('hidden');
    loginPasswordError.classList.add('hidden');

    const email = loginEmail.value.trim();
    const password = loginPassword.value;

    if (!loginEmail.validity.valid || !email) {
      loginEmailError.classList.remove('hidden'); return;
    }
    if (!password) {
      loginPasswordError.classList.remove('hidden'); return;
    }

    await handleSignIn(email, password, { allowStoreCredential: true });
  });

  // ====== Use the Credential Management API to get saved password and show the chooser/drawer ======
  async function tryAutoChooseCredential() {
    if (!navigator.credentials || !navigator.credentials.get) return null;
    try {
      // mediation: 'optional' allows the browser to show the credential chooser UI (the drawer)
      const cred = await navigator.credentials.get({ password: true, mediation: 'optional' });
      // cred can be null if user dismisses the chooser or browser has nothing to show
      if (!cred) return null;

      // PasswordCredential gives us id (username) and password
      // On Chrome/Android the chooser you screenshot will be used when this resolves
      if (cred.type === 'password' || cred.password) {
        // If you want to auto-fill the fields:
        loginEmail.value = cred.id || loginEmail.value;
        loginPassword.value = cred.password || '';
        // Option: automatically submit (be mindful of UX / consent). I show a small lightweight confirmation:
        await handleSignIn(cred.id, cred.password, { allowStoreCredential: false });
        return cred;
      }
    } catch (e) {
      console.warn('navigator.credentials.get error', e);
      return null;
    }
  }

  // run on load so user sees the browser chooser if available
  tryAutoChooseCredential();

}); // DOMContentLoaded end
</script>

</body>
</html>




